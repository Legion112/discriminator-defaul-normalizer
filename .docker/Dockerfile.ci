FROM ghcr.io/legion112/discriminator-default-normalizer/base:latest as composerdependency
ENV COMPOSER_CACHE_DIR=/tmp/.cache/composer
COPY composer.lock /app/
COPY composer.json /app/

RUN   --mount=type=cache,target=$COMPOSER_CACHE_DIR \
      --mount=type=bind,from=composer:2,source=/usr/bin/composer,target=/usr/local/bin/composer \
      composer install --no-autoloader
# Install dependency
FROM ghcr.io/legion112/discriminator-default-normalizer/base:latest
COPY --chown=app:app . /app
COPY --from=composerdependency --chown=app:app /app/vendor/ /app/vendor/
# Create autoload config
RUN  --mount=type=bind,from=composer:2,source=/usr/bin/composer,target=/usr/local/bin/composer \
      composer dump --optimize
